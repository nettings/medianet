# Hardware

Der medianet-Audio-Node basiert auf einem Raspberry Pi 3 (ARM mit hardfloat) und einem HifiBerry-Audio-Interface.
Das Betriebssystem ist ein debian-basiertes Linux, Raspbian Stretch.
Lokale Anpassungen für unseren Bedarf finden sich in /medianet. Wenn eine Konfigurationsdatei o.ä. angepasst werden muss, wird sie in ein Unterverzeichnis von /medianet entsprechend ihres ursprünglichen Standorts verschoben (also z.b. von /etc/systemd nach /medianet/etc/systemd) und vom ursprünglichen Ort aus symbolisch verlinkt (ln -s).
Dabei wird die Originalkonfiguration weitgehend übernommen und unsere Änderungen am Schluss in einer gesondert markierten Sektion eingefügt.
Der Benutzername ist "medianet", sein Passwort auf Testsystemen ist "[mn]prototype". Auf Produktionssystemen wird das Passwort gesperrt (usermod -L medianet), so dass nur SSH-schlüsselbasierte Logins möglich sind.

# Software

Das System arbeitet im Produktivbetrieb mit read-only-Dateisystemen und ist daher robust gegen unsauberes Herunterfahren.

Alle medianet-spezifischen Dienste werden vom systemd verwaltet, siehe /medianet/etc/systemd/sytem.
Im einzelnen finden sich hier:

* der JACK-Server, er hat exklusiv Zugriff auf die Sound-Hardware und ermöglicht den Signalfluss zwischen anderen Audio-Applikationen wie Plugin-Hosts, Mediaplayern oder Streamquellen und -senken
* ein cpufreq-Dienst, der das Clocking-Verhalten des Prozessors kontrolliert. Für 100% dropout-freien Betrieb pinnt man alle Cores auf voller Taktfrequenz, allerdings erhöht sich dadurch der Stromverbrauch.
* der mod-host, ein JACK-basierter Plugin-Host. In ihm findet die anwendungsspezifische Signalverarbeitung statt.
* die zita-njbridge, eine Netzwerk-nach-JACK-Bridge, mit der im Netz verfügbare Streams abgegriffen werden können. Eingehendes Audio wird adaptiv auf die lokale Audio-Clock neu abgetastet.
* ein lighttpd-Webserver mit PHP7, er exportiert das Web-Interface der Plugins des mod-host. Zu erreichen über localhost:80, es empfiehlt sich also ein Login per "ssh -L 10080:localhost:80 medianet@hostname" und dann im Browser des zugreifenden Rechners auf http://localhost:10080.

Unter /medianet/usr/local/bin befindet sich eine Sammlung von Skripten, die für die Wartung des Systems hilfreich sind. Dazu gehören insbesondere "mn_make_writable" und "mn_make_readonly". Der Status der Dateisysteme wird im Shell-Prompt angezeigt (siehe /medianet/etc/bash.bashrc).
Im Unterverzeichnis /medianet/usr/local/bin/install wird die Einrichtung eines medianet-Systems auf der Grundlage eines Vanilla-Raspbian dokumentiert, indem alle nötigen Arbeitsschritte in Form von Skripten festgehalten werden.

## systemd-Konfiguration 

Wichtig: unbedingt das Löschen von tmpfiles beim logout in /etc/systemd/logind.conf deaktivieren, sonst killt der systemd den JACK-Server (der hat sockets und semaphores in /dev/shm)!
 
## Jack-Konfiguration

siehe /medianet/medianet.conf

## cpufreq-Konfiguration

siehe /medianet/medianet.conf

## mod-host-Konfiguration

Siehe /medianet/medianet.conf und /medianet/mod-host.cmd. Aus dieser Datei wird durch das Tool "/home/medianet/lv2rdf2html" automatisch ein Web-Interface generiert und auf dem lighttpd-Server exportiert.

## zita-njbridge-Konfiguration

siehe /medianet/medianet.conf

## lighttpd-Konfiguration

Siehe /medianet/etc/lighttpd/.

# TODO

* falls im Produktivbetrieb, PHP-Session-Support in der php.ini deaktivieren.
* Logging auf externen Logserver einrichten, derzeit sind die Logs im RAM und gehen im Fehlerfall verloren.

# BUGS

* Umschalten der CPU-Frequenz führt zu dropouts im Audio.
* lv2rdf2html kann noch nicht mit mehreren Instanzen desselben Plugins umgehen.

