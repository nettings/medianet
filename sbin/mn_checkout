#!/bin/bash

BASEDIR=`dirname $0`
FIND=/usr/bin/find

. "$BASEDIR"/../lib/mn_includes

# from_FOO <URL> <dirname>
from_git() {
  if [[ ! -d "$2" ]] ; then
    echo -ne "Cloning $1 into $2..."
    git clone -q "$1" "$2" || failure && success
  else
    echo -ne "Git repository exists. Updating..."
    cd "$2"
    git pull || failure && success
    cd ..
  fi
}

from_tar() {
  echo -ne "Installing tarball $1 to $2..."
  if [[ ! -d "$2" ]] ; then
    mkdir "$2"
  fi
  cd "$2"
  ALGO=
  case `basename "$1"` in
    *.gz|*.tgz)
      ALGO=z
      ;;
    *.bz2|*.tbz)
      ALGO=j
      ;;
    *.xz)
      ALGO=J
      ;;
  esac
  wget -q -O - "$1" | tar --strip-components=1 -x -$ALGO -f - || failure && success
  cd ..
}

from_package()
{
  while [[ -n "$1" ]] ; do
	echo -ne "Installing package $1..."
  	sudo apt-get -qqy install --no-install-recommends "$1" || failure && success
  	shift
  done
}


OLDWD=`pwd`
cd "$BASEDIR"/../custom_builds

if [[ -n "$1" ]] ; then
	TARGET="$1.checkout"
else
	TARGET="*.checkout"
fi

scream "Checking out \"$TARGET\"."

$FIND -name "$TARGET" | while read line ; do
  scream "********* Checking out $line..."
  . "$line" \
    && scream "********* ... $line and dependencies successfully checked out." \
    || { 
      scream "********* ... $line " 
      bail
    }
done

cd "$OLDWD"
echo "Checked out sources have been installed to `realpath -e $DESTDIR/../`."


