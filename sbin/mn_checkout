#!/bin/bash

BASEDIR=`dirname $0`
FIND=/usr/bin/find

. "$BASEDIR"/../lib/mn_includes

# from_FOO <URL> <dirname>
from_git() {
  if [[ ! -d "$2" ]] ; then
    git clone "$1" "$2"
  else
    cd "$2"
    git pull
    cd ..
  fi
}

from_tar() {
  if [[ ! -d "$2" ]] ; then
    mkdir "$2"
  fi
  cd "$2"
  ALGO=
  case `basename "$1"` in
    *.gz|*.tgz)
      ALGO=z
      ;;
    *.bz2|*.tbz)
      ALGO=j
      ;;
    *.xz)
      ALGO=J
      ;;
  esac
  wget -O - "$1" | tar --strip-components=1 -x -v -$ALGO -f -
  cd ..
}

OLDWD=`pwd`
cd "$BASEDIR"/../custom_builds

if [[ -n "$1" ]] ; then
	TARGET="$1.checkout"
else
	TARGET="*.checkout"
fi

scream "Checking out \"$TARGET\"."

$FIND -name "$TARGET" | while read line ; do
  scream "********* Checking out $line...\n"
  . "$line" \
    && scream "********* ...$line and dependencies successfully checked out.\n" \
    || { 
      scream "********* ...$line " 
      bail
    }
done

cd "$OLDWD"
echo "Checked out sources have been installed to `realpath $DESTDIR/../`."


