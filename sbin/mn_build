#!/bin/bash

. /medianet/lib/mn_includes

needroot

OLDWD=`pwd`
DESTDIR="$PREFIX"/overlay
cd "$PREFIX"/custom_builds

if [[ -n "$1" ]] ; then
	TARGET="$1.build"
else
	TARGET="*.build"
fi

scream "Building \"$TARGET\"."

"$FIND" -name "$TARGET" | while read line ; do
  line=`"$READLINK" --canonicalize "$line"`
  WORKDIR=`echo "$line" | "$SED" 's/\.build$//'`
  cd "$WORKDIR"
  scream "********* Compiling $line...\n"
  . "$line" \
    && scream "********* ...$line successfully compiled and installed.\n" \
    || { 
      scream "********* ...$line " 
      failure
    }
  cd ..
done

cd "$OLDWD"
echo "Compiled programs have been installed to $DESTDIR. Deploy with 'sudo $PREFIX/sbin/mn_deploy_overlay' to activate them."
