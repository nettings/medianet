#!/bin/bash

BASEDIR=`dirname $0`/..
. "$BASEDIR"/bin/mn_includes

# This script deploys all files in the medianet/boot directory as symbolic links
# throughout the distribution file system.

OLDPWD=$PWD
# we're deploying the main overlay
cd "$BASEDIR"/boot

scream "Checking directory tree..."
# Iterate over all directories in overlay
for DIR in `find -P * -type d` ; do
	TARGET=/boot/"$DIR"
	echo -n "$TARGET:"
	if [[ ! -d "$TARGET" ]] ; then
		echo " creating..."
		mkdir "$TARGET" && success || bail
	else
		echo " exists."
	fi
done

scream "Deploying overlay..."
# Iterate over all files in overlay
for SOURCE in `find -P * \! -name README \! -type d` ; do
	TARGET=/boot/"$SOURCE"
	BACKUP=/"$SOURCE".mn_

	echo "$TARGET:" 
	echo -en "\tBackup"
	# Check if regular file exists in distribution file system, if so: back it up.
	if [[ ( -f "$TARGET" && ! -L "$TARGET" ) ]] ; then
		# Do not overwrite existing backups.
		if [[ ! -e "$BACKUP" ]] ; then
			mv "$TARGET" "$BACKUP" \
				&& success || bail
		else echo " already exists."
		fi
	else
		echo " not required."
	fi
	# Replace original file with symbolic link to medianet overlay.
	if [[ -e "$TARGET" ]] ; then
		echo -ne "\tRemoving existing..."
		rm -r "$TARGET" && success || failure
	fi
	echo -ne "\tInstalling..."
	cp "$PWD"/"$SOURCE" "$TARGET" \
		&& success || bail
done

cd "$OLDPWD"

