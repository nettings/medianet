#!/bin/bash

BASEDIR=`dirname $0`
. "$BASEDIR"/mn_includes

OLDPWD=`pwd`
DESTDIR=`realpath "$BASEDIR"/../overlay`
if [[ -z "$1" ]] ; then
  TARGET='mn_compile.*.*'
else
  TARGET='mn_compile.*.'$1
fi

scream "Iterating over \"$TARGET\"."

cd "$BASEDIR"/../custom_builds

find "$BASEDIR" -name "$TARGET" ! -name "*~" | sort | while read line ; do
  line=`realpath "$line"`
  WORKDIR=`echo "$line" | cut -d "." -f 3-`
  cd "$WORKDIR"
  scream "Compiling \"$line\"..."
  . "$line" "$DESTDIR" && success || bail
  cd ..
done

echo "Compiled programs have been installed to $DESTDIR. Deploy with 'sudo "$BASEDIR"/mn_deploy_overlay' to activate them."
