#!/bin/bash

. /medianet/lib/mn_includes

THIS=$("$BASENAME" $0)

case "$1" in 
	-h|--help)
		echo -n "This tool prints out the "
		case "$THIS" in 
			mn_net_ip)
				echo -n "IP address"
				;;
			mn_net_dev)
				echo -n "name"
				;;
			mn_net_mask)
				echo -n "network mask"
				;;
			mn_net_neighbours)
				echo -n "network neighbour hosts"
		esac
		echo " of the network device that has the default route"
		echo "(usually the internet connection)."
		exit 1
		;;
esac

DEFAULT_ROUTE4=$("$IPBIN" route list | "$GREP" '^default')
MY_IP4=$(echo "$DEFAULT_ROUTE4" | "$CUT" -d ' ' -f 9)
MY_DEV4=$(echo "$DEFAULT_ROUTE4" | "$CUT" -d ' ' -f 5)
MY_MASK4=$("$IPBIN" address | "$GREP" -oP "(?<=${MY_IP4})/[0-9]{1,2}" )

MY_IP6=$MY_IP4
MY_DEV6=$MY_DEV4

case "$THIS" in
	mn_net_ip)
		echo "$MY_IP4"
		;;
	mn_net_dev)
		echo "$MY_DEV4"
		;;
	mn_net_mask)
		echo "$MY_MASK4"
		;;
	mn_net_neighbours)
		needroot
#		"$NMAP" -sP "${MY_IP}${MY_MASK}"
#		echo -e "\n\n\n"
		"$NMAP" -sP "${MY_IP4}${MY_MASK4}" \
		| "$SED" -E "\
			s/Starting Nmap.*//;\
			s/Nmap scan report for ([A-Za-z][A-Za-z0-9-]+)?\.?[^[:blank:]]* ?\(?([0-9.]*]?)\)?.*/\1;\2;/;\
			s/^Host is.*$//;\
			s/^MAC Address:[[:blank:]]*([a-fA-F0-9:]{17}) \((.*)\)/\1;\2=/;\
			s/Nmap done.*/==/\
		" \
		| "$TR" -d '\n' \
		| "$TR" '=' '\n' \
		| "$SORT" -d -t ";"  -k 4 \
		| column -t -s ";"

		echo -e "\n\n\n"
		
		"$NMAP" -6 -e ${MY_DEV6} -sP \
			$(\
				ping -c 2 -6 -I ${MY_DEV6} ff02::1 2> /dev/null \
				| "$SED" -E 's/.*(fe80:[a-f0-9:]+)%.*/\1/' \
				| "$GREP" '^fe80' \
				| "$TR" '\n' ' ' \
			) \
		| "$SED" -E "\
			s/Starting Nmap.*//;\
			s/Nmap scan report for ?\(?([0-9a-f:.]*]?)\)?.*/\1;/;\
			s/^Host is.*$//;\
			s/^MAC Address:[[:blank:]]*([a-fA-F0-9:]{17}) \((.*)\)/\1;\2=/;\
			s/Nmap done.*/==/\
		" \
		| "$TR" -d '\n' \
		| "$TR" '=' '\n' \
		| "$SORT" -d -t ";"  -k 3 \
		| column -t -s ";"

			
		;;				
esac

