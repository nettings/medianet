#!/bin/bash

. /medianet/lib/mn_includes

. /etc/systemd/system/$1.d/$1.connections

echo -n "$1 waiting for own ports "
OWNPORTS=
while read PORT; do
	if [[ ! "$PORT" ]] ; then break ; fi
	echo -n "$PORT"
	/usr/local/bin/mn_wait_jack "$PORT"
	echo -n " (x)  "
	read FOREIGNPORT
done <<< "$CONNECTIONS_OUT"
while read FOREIGNPORT; do
	read PORT
	if [[ ! "$PORT" ]] ; then break ; fi
	echo -n "$PORT"
	/usr/local/bin/mn_wait_jack "$PORT"
	echo -n " (x)  "
done <<< "$CONNECTIONS_IN"
echo " - all found."
#echo -n $OWNPORTS"..."
#/usr/local/bin/mn_wait_jack "$OWNPORTS" 
#echo "found."

N=0
while read OUTPORT ; do
	if [[ ! "$OUTPORT" ]] ; then break ; fi
	read INPORT
	echo -n "$1 [$((N++))] connecting $OUTPORT -> $INPORT... "
	{
		RES=`jack_connect $OUTPORT $INPORT 2>&1`
		if [[ -z "$RES" ]] ; then 
			success
		elif $GREP -q "already connected" <<< "$RES" ; then
			echo "already connected."
		else
			echo "failed ($RES). Continuing."
		fi
	} 
done <<< "$CONNECTIONS_IN $CONNECTIONS_OUT"
