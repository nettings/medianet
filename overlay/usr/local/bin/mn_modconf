#!/bin/bash

. /medianet/lib/mn_includes

case $1 in
  --base-setup)
    # get base configuration from system-wide config file:
    CONF="`cat $CONF_FILE_MODHOST`"
    ;;
  --parameters)
    # get user parameter settings from persistent storage,
    CONF="`cat $CONF_FILE_MODHOST_STATE` 2> /dev/null"
    ;;
  --all)
    $0 --base-setup
    $0 --parameters
    exit 0
    ;;
  *)
    echo "$0 [--base-setup ][--parameters ][--all]"
    echo "configures a running mod-host instance via its local telnet interface."
    echo "--base-setup sets the mod-host base configuration defined in $SYSTEM_CONFIG."
    echo "--parameters restores the most recent user settings of the plugin chain."
    echo "--all does both."
    ;;
esac

# wait for mod-host to become ready
until echo "" | nc -N localhost 5555 > /dev/null; do sleep 1; done
echo "$CONF" | grep -v -e "^#" | while read -r line ; do
	echo "$line"
	test -n "$line" && echo $line | nc -N localhost 5555
	echo 
done
# make systemd happy if mod-host chokes on spurious whitespace with non-zero nc exit code
exit 0

