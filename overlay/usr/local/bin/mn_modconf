#!/bin/bash

./medianet/bin/mn_includes

. $MEDIANETCONF

unset -v CFILE

case $1 in
  --base-setup)
    CFILE=$MOD_CMDFILE
    ;;
  --parameters)
    # look for latest file in dir:
    for file in "$MOD_SETTINGSDIR"/*; do
      test "$file" -nt "$CFILE" && CFILE=$file
    done
    ;;
  --all|*)
    $0 --base-setup
    $0 --parameters
    exit 0
    ;;
esac

# wait for mod-host to become ready
until echo "" | nc -N localhost 5555 > /dev/null; do sleep 1; done
cat "$CFILE" | grep -v -e "^#" | while read -r line ; do
	echo "$line"
	test -n "$line" && echo $line | nc -N localhost 5555
	echo 
done
# make systemd happy if mod-host chokes on spurious whitespace with non-zero nc exit code
exit 0

