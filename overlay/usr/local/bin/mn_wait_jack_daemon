#!/bin/bash


. /medianet/lib/mn_includes

JACK_SOCKET_PATH=/dev/shm
ERR_TIMEOUT=2

function help {
	cat << EOF

${PROGNAME} blocks until a JACK socket appears in $JACK_SOCKET_PATH.
You can use it to make sure a JACK server is available before performing
other tasks.

Usage: $PROGNAME -t 5 && echo "found JACK!" || echo "Timeout expired."

	--help		This help.
	 -h

	--timeout n	A timeout in seconds. If it expires, terminate
	 -t		with return value $ERR_TIMEOUT.

	--verbose	Write messages to stdout.
	 -v

EOF
}

function message {
	if [[ -n "$VERBOSE" ]] ; then
		echo $1
	fi
}

TIMEOUT=
VERBOSE=

while [[ -n "$1" ]] ; do
	case "$1" in
	-h|--help)
		help
		exit 254
		;;
	-t|--timeout)
		if [[ "$2" =~ [0-9]+ ]] ; then
			TIMEOUT=$2
			shift
		else
			bail "--timeout requires a numerical argument (timeout in seconds)"
		fi
		;;
	-v|--verbose)
		VERBOSE=1
		;;
	-*)
		bail "Unknown option $1."
		;;
	*)
		bail "Unknown argument $1."
		;;
	esac
	shift
done

JACK_SOCKET=
while [[ $((TIMEOUT--)) -gt 0 ]] ; do
	JACK_SOCKET=$( \
		"$FIND" "$JACK_SOCKET_PATH" \
			-type s \
			-regextype posix-extended \
			-regex '/dev/shm/jack_[[:alnum:]]+_[0-9]+_[0-9]+' \
			-exec ls -1 {} \; 2> /dev/null \
	)
	if [[ -n "$JACK_SOCKET" ]] ; then
		message "Found $JACK_SOCKET. JACK server is ready!"
		exit 0
	fi
	sleep 1
done
message "Timeout expired."
exit $ERR_TIMEOUT
