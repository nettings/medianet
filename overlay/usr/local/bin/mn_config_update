#!/bin/bash

. /medianet/lib/mn_includes

needroot

if [[ -n "$1" ]] ; then
	CONFIG_FILE="$1"
else
	CONFIG_FILE="$SYSTEM_CONFIG"
fi

if [[ ! -e "$CONFIG_FILE" ]] ; then
	bail "$CONFIG_FILE does not exist."
fi

NOEDIT="# automatically created by $PROGNAME from $CONFIG_FILE, do not edit!"


scream "Update product/description/hostname/location/version"

CONFIG=
DATA=`cat "$CONFIG_FILE" | jq -r '.product, .description, .hostname, .location, .version'`
while read VALUE; do
	CONFIG+="CONFIG_PRODUCT=\"$VALUE\"\n"
	read VALUE
	CONFIG+="CONFIG_DESCRIPTION=\"$VALUE\"\n"
	read VALUE
	CONFIG+="CONFIG_HOSTNAME=\"$VALUE\"\n"
	echo -n "Updating /etc/hostname to $VALUE..."
	if [[ `cat /etc/hostname 2> /dev/null | tr -d '[:space:]'` != "$VALUE" ]] ; then 
		echo "$VALUE" > /etc/hostname && success || failure
	else
		echo " not changed".
	fi
	echo -n "Updating /etc/hosts to $VALUE..."
	"$SED" -i "s/$HOSTNAME/$VALUE/g" /etc/hosts && success || failure
	echo -n "Setting hostname to $VALUE..."
	"$HOSTNAMEBIN" "$VALUE" && success || failure
	read VALUE
	CONFIG+="CONFIG_LOCATION=\"$VALUE\"\n"
	read VALUE
	CONFIG+="CONFIG_VERSION=\"$VALUE\"\n"
	break
done <<< "$DATA"


scream "Setting CONFIG_ variables:"

echo -en "$CONFIG"
CONFIG="$NOEDIT\n$CONFIG"
echo -n "Updating $CONFIG_INCLUDE..."
echo -e "$CONFIG" > "$CONFIG_INCLUDE" && success || failure


scream "Update boot configuration in $CONF_FILE_BOOT:"

CONFIG=
# we assume anything that is not a dtparam or a dtoverlay can occur only once
# this becomes important if we later combine default settings with overrides
CONFIG="# singleton parameters\n"
DATA=`cat "$CONFIG_FILE"  | jq -r '.bootConfig | del(.dtoverlay) | del(.dtparam) | keys_unsorted[] as $k | "\($k)\n\(.[$k])"'`
while read KEY ; do
	read VALUE
	CONFIG+="$KEY=$VALUE\n"
done <<< "$DATA"
# dtoverlay can occur multiple times. we preserve the original order and rely
# on the config.txt parser to do the right thing (latest takes precedence)
CONFIG+="# dtoverlay parameters\n"
DATA=`cat "$CONFIG_FILE"  | jq -r '.bootConfig.dtoverlay[]'`
while read VALUE ; do
	CONFIG+="dtoverlay=$VALUE\n"
done <<< "$DATA"
# same for dtparam
CONFIG+="# dtparam parameters\n"
DATA=`cat "$CONFIG_FILE"  | jq -r '.bootConfig.dtparam|keys_unsorted[] as $k | "\($k)\n\(.[$k])"'`
while read KEY ; do
	read VALUE
	CONFIG+="dtparam=$KEY=$VALUE\n"
done <<< "$DATA"
echo -en "$CONFIG"
echo -n "writing out to $CONF_FILE_BOOT..."
echo -en "$CONFIG" > "$CONF_FILE_BOOT" && success || failure


scream "Update systemd unit status:"

DATA=`cat "$CONFIG_FILE" | jq -r '.systemdUnits[] | select(.enabled == 0) | "\(.unit).\(.type)"'`
while read SERVICE ; do
	"$SYSTEMCTL" --quiet is-enabled "$SERVICE" 2> /dev/null && {
		echo -n "Disabling $SERVICE..."
		"$SYSTEMCTL" disable "$SERVICE" && success || failure
	} || echo "$SERVICE already disabled."
done <<< "$DATA"
DATA=`cat "$CONFIG_FILE" | jq -r '.systemdUnits[] | select(.enabled == 1) | "\(.unit).\(.type)"'`
while read SERVICE ; do
	"$SYSTEMCTL" --quiet is-enabled  "$SERVICE" && {
		echo "$SERVICE is already enabled."
	} || {
		echo -e "Enabling $SERVICE..."
		"$SYSTEMCTL" --quiet enable "$SYSTEMD_UNITS_LOCAL"/"$SERVICE" && success || failure
	}
done <<< "$DATA"


scream "Update systemd unit options:"

CONFIG=
DATA=`cat "$CONFIG_FILE" | jq -r '.systemdUnits[] | select(.options) | "\(.unit)\n\(.type)\n\(.jackName)\n\(.options)"'`
while read UNIT ; do
	read TYPE
	DROPIN_DIR="$SYSTEMD_UNIT_DIR"/"$UNIT"."$TYPE".d
	DROPIN_FILE="$UNIT"."$TYPE".conf
	if [[ ! -e "$DROPIN_DIR" ]] ; then
		echo -n "Creating $DROPIN_DIR..."
		mkdir "$DROPIN_DIR" && success || failure
	fi
	read JACKNAME
	read OPTIONS
	CONFIG="Environment=\"OPTIONS="
	CONFIG+=`echo $OPTIONS | sed "s/%jackName%/\'$JACKNAME\'/g"`
	CONFIG+="\""
	echo "Writing to $DROPIN_DIR/$DROPIN_FILE ..."
	echo -e "$CONFIG"
	CONFIG="$NOEDIT\n\n\n[Service]\n\n$CONFIG"
	echo -e "$CONFIG" > "$DROPIN_DIR"/"$DROPIN_FILE" && success || failure

	CONFIG=
	COUT=`cat "$CONFIG_FILE" | jq --arg unit $UNIT -rjf "$PREFIX"/overlay/usr/local/lib/mn_config/output_connections.jq`
	if [[ "$COUT" ]] ; then
		CONFIG="CONNECTIONS_OUT=\"$COUT\n\"\n"
	fi
	CIN=`cat "$CONFIG_FILE" | jq --arg unit $UNIT -rjf "$PREFIX"/overlay/usr/local/lib/mn_config/input_connections.jq`
	if [[ "$CIN" ]] ; then
		CONFIG+="CONNECTIONS_IN=\"$CIN\n\"\n"
	fi

	echo "Writing to $DROPIN_DIR/$UNIT.$TYPE.connections ..."
	echo -e "$CONFIG"
	CONFIG="$NOEDIT\n\n$CONFIG"
	echo -e "$CONFIG" > "$DROPIN_DIR"/"$UNIT"."$TYPE".connections && success || failure

done <<< "$DATA"


scream "Update systemd daemon settings:"

echo -n "Performing 'systemctl daemon-reload'..."
$SYSTEMCTL daemon-reload && success || failure


scream "Update mod-host configuration:"

CONFIG=
DATA=`cat "$CONFIG_FILE" | jq -r '.systemdUnits[] | select(.unit == "mod-host") | .config[]'`
while read COMMAND ; do
	CONFIG+="$COMMAND\n"
done <<< "$DATA"
echo -en "$CONFIG"
CONFIG="$NOEDIT\n\n$CONFIG"
echo -n "Writing to $CONF_FILE_MODHOST..."
echo -e "$CONFIG" > "$CONF_FILE_MODHOST" && success || failure


scream "Update zita-lrx configuration:"

CONFIG=
DATA=`cat "$CONFIG_FILE" | jq -r '.systemdUnits[] | select(.unit == "zita-lrx") | .config[]'`
while read COMMAND ; do
	CONFIG+="$COMMAND\n"
done <<< "$DATA"
echo -en "$CONFIG"
CONFIG="$NOEDIT\n$CONFIG"
echo -n "Writing to $CONF_FILE_ZITALRX..."
echo -e "$CONFIG" > "$CONF_FILE_ZITALRX" && success || failure
